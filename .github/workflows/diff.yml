name: Diff
on:
  pull_request:
jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs')
            const body = fs.readFileSync('.github/diff_comment_template.md', 'utf8')
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
  diff:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: actions/checkout@v2
        with:
          ref: ${{ github.base_ref }}
          path: base

      - uses: actions/setup-node@v2
        with:
          node-version: 14

      - name: Install dependencies
        run: yarn

      - name: Build
        run: yarn build

      - name: Install dependencies (base)
        run: pushd base; yarn; popd

      - name: Build (base)
        run: pushd base; yarn build; popd

      # - name: Diff
      #   run: |
      #     diff=$(for file in dist/scss/**/*.scss
      #       do
      #         # using `2> /dev/null || true` here to suppress errors because,
      #         # in this case, differences are not errors
      #         diff -U 1 base/$file $file 2> /dev/null || true
      #       done)
      #     echo "$diff"
      - name: Diff
        uses: primer/comment-token-update@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: github-actions[bot]
        with:
          comment-token: 'diff'
          script: |
            diff=$(for file in dist/scss/**/*.scss
              do
                # using `2> /dev/null || true` here to suppress errors because,
                # in this case, differences are not errors
                diff -U 1 base/$file $file 2> /dev/null || true
              done)
            if [[ $diff ]]; then
              echo "\`\`\`diff"
              echo "$diff"
              echo "\`\`\`"
            fi
